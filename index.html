<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ‘¾ ã°ã‘ã°ã‘å¬å–šè£…ç½®ï¼ˆFirebaseç‰ˆï¼‰</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Courier New', monospace;
      background: #0a1a0f;
      color: #00ff88;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background:
        radial-gradient(circle at 20% 50%, rgba(0,255,136,0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(0,200,100,0.15) 0%, transparent 50%);
      animation: wave 20s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }
    @keyframes wave {
      0%,100% { transform: translate(0,0) rotate(0deg); }
      25% { transform: translate(5%,5%) rotate(1deg); }
      50% { transform: translate(-3%,3%) rotate(-1deg); }
      75% { transform: translate(3%,-5%) rotate(0.5deg); }
    }

    .scanline {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: repeating-linear-gradient(
        0deg,
        rgba(0,255,136,0.03) 0px,
        transparent 2px,
        transparent 4px
      );
      pointer-events: none;
      z-index: 9999;
    }

    header {
      grid-column: 1 / -1;
      text-align: center;
      margin-bottom: 20px;
    }
    h1 {
      font-size: 72px;
      text-shadow: 0 0 3px #00ff88, 0 0 5px #00ff88, 0 0 10px #00ff88;
      letter-spacing: 12px;
      animation: flicker 3s infinite;
      margin-bottom: 15px;
    }
    @keyframes flicker { 0%,100% { opacity: 1; } 50% { opacity: 0.97; } }
    .subtitle { font-size: 14px; color: #00cc70; letter-spacing: 3px; }

    .settings-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,255,136,0.2);
      border: 2px solid #00ff88;
      color: #00ff88;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      z-index: 10000;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      transition: all 0.3s;
    }
    .settings-btn:hover {
      background: rgba(0,255,136,0.4);
      box-shadow: 0 0 15px rgba(0,255,136,0.5);
    }

    .container {
      position: relative; z-index: 2;
      display: grid;
      grid-template-columns: 320px 1fr 320px;
      gap: 20px;
      padding: 20px;
      max-width: 1600px;
      margin: 0 auto;
      min-height: 100vh;
    }

    .panel {
      background: rgba(20,10,30,0.85);
      border: 2px solid #00ff88;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(0,255,136,0.3);
    }

    .left-panel, .center-panel, .right-panel {
      display: flex; flex-direction: column; gap: 20px;
    }

    .section-title {
      font-size: 18px; color: #00ff88;
      border-bottom: 2px solid #00ff88;
      padding-bottom: 8px; margin-bottom: 15px;
      text-shadow: 0 0 10px #00ff88;
    }

    input[type="text"], textarea {
      width: 100%; padding: 12px;
      background: rgba(10,5,20,0.8);
      border: 2px solid #00ff88;
      border-radius: 8px;
      color: #00ff88;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    textarea { min-height: 80px; resize: vertical; }

    .file-upload {
      border: 2px dashed #00ff88;
      padding: 25px; text-align: center;
      border-radius: 8px; cursor: pointer;
      background: rgba(0,255,136,0.05);
      transition: all 0.3s;
    }
    .file-upload:hover {
      background: rgba(0,255,136,0.1);
      box-shadow: 0 0 15px rgba(0,255,136,0.5);
    }
    #preview {
      max-width: 100%; border-radius: 8px;
      margin-top: 15px; display: none;
      border: 2px solid #00ff88;
      box-shadow: 0 0 10px rgba(0,255,136,0.3);
    }

    .image-display {
      flex: 1;
      background: rgba(10,5,20,0.6);
      border: 2px solid #00ff88;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      aspect-ratio: 16 / 10;
      max-height: 500px;
      position: relative; overflow: hidden;
    }

    button {
      width: 100%; padding: 15px;
      background: linear-gradient(135deg,#00ff88 0%,#00cc70 100%);
      color: #0a1a0f;
      border: none; border-radius: 8px;
      font-size: 16px; font-weight: bold;
      font-family: 'Courier New', monospace;
      cursor: pointer; transition: all 0.3s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,255,136,0.5); }
    button:disabled { background: #333; color: #666; cursor: not-allowed; transform: none; }

    .save-btn {
      background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
      color: #1a0a00;
    }
    .save-btn:hover { box-shadow: 0 5px 15px rgba(255,170,0,0.5); }

    .slider-container {
      background: rgba(10,5,20,0.5);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #00ff88;
    }
    .slider-label {
      display: flex; justify-content: space-between;
      margin-bottom: 10px; font-size: 12px;
    }
    .current-value {
      font-weight: bold; font-size: 18px; color: #00ff88;
      text-shadow: 0 0 10px #00ff88;
    }
    input[type="range"] {
      width: 100%; height: 6px;
      background: rgba(0,255,136,0.2);
      outline: none; border-radius: 3px; -webkit-appearance: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 20px; height: 20px;
      background: #00ff88; border-radius: 50%;
      cursor: pointer; box-shadow: 0 0 10px #00ff88;
    }
    input[type="range"]::-moz-range-thumb {
      width: 20px; height: 20px; background: #00ff88;
      border-radius: 50%; cursor: pointer; border: none; box-shadow: 0 0 10px #00ff88;
    }

    .preset-btns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; }
    .preset-btn {
      padding: 8px;
      background: rgba(0,255,136,0.1);
      border: 1px solid #00ff88;
      border-radius: 6px;
      color: #00ff88;
      cursor: pointer;
      font-size: 11px;
      font-family: 'Courier New', monospace;
      transition: all 0.3s;
    }
    .preset-btn:hover { background: rgba(0,255,136,0.2); }
    .description-box {
      background: rgba(0,255,136,0.05);
      padding: 10px; border-radius: 6px; font-size: 11px; color: #00cc70; margin-top: 10px; border-left: 3px solid #00ff88;
    }

    .loading { text-align: center; padding: 20px; display: none; }
    .loading-text { font-size: 20px; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

    .progress-wrap {
      margin-top: 12px;
      text-align: left;
    }
    .progress-label {
      font-size: 12px; opacity: .8; margin-bottom: 6px;
      display: flex; justify-content: space-between;
    }
    .progress-bar-bg {
      width: 100%; height: 20px;
      background: rgba(10,5,20,0.8);
      border: 1px solid #00ff88;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #00ff88, #00cc70);
      width: 0%;
      transition: width 0.2s ease-out;
      box-shadow: 0 0 10px rgba(0,255,136,0.6);
    }

    .status-message {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
      border-left: 4px solid;
    }
    #error {
      background: rgba(255,50,50,0.2);
      border-color: #ff3333;
      color: #ff8888;
    }
    #success {
      background: rgba(0,255,136,0.2);
      border-color: #00ff88;
      color: #00ff88;
    }

    .placeholder-text {
      color: #00cc70;
      font-size: 24px;
      text-align: center;
      opacity: 0.6;
    }

    #resultImage {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 8px;
    }

    .firebase-status {
      font-size: 11px;
      color: #00cc70;
      margin-top: 10px;
      padding: 8px;
      background: rgba(0,255,136,0.05);
      border-radius: 6px;
      border-left: 3px solid #00ff88;
    }
  </style>
</head>
<body>
  <div class="scanline"></div>
  <button class="settings-btn" onclick="openSettings()">âš™ï¸ APIè¨­å®š</button>
  
  <div class="container">
    <header>
      <h1>ğŸ‘¾ ã°ã‘ã°ã‘å¬å–šè£…ç½® ğŸ‘¾</h1>
      <div class="subtitle">YOKAI MONSTER SUMMONER - FIREBASE EDITION</div>
    </header>

    <!-- å·¦ãƒ‘ãƒãƒ«: åŸæ–™æŠ•å…¥ -->
    <div class="left-panel panel">
      <div class="section-title">åŸæ–™æŠ•å…¥</div>
      
      <div class="file-upload" onclick="document.getElementById('imageInput').click()">
        ğŸ“¸ ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰<br>
        <small style="opacity: 0.7;">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</small>
        <input type="file" id="imageInput" accept="image/*" style="display: none;" />
      </div>
      <img id="preview" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" />

      <div>
        <label style="display: block; margin-bottom: 8px; font-size: 12px;">å¦–æ€ªã®åå‰</label>
        <input type="text" id="monsterName" placeholder="ä¾‹: æ²³ç«¥ã€å¤©ç‹—ã€ã‚ãã‚é¦–" />
      </div>

      <div>
        <label style="display: block; margin-bottom: 8px; font-size: 12px;">è¿½åŠ æŒ‡ç¤º</label>
        <textarea id="customPrompt" placeholder="ä¾‹: ç‚ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ã€å¤œã®é›°å›²æ°—ã§"></textarea>
      </div>

      <div class="slider-container">
        <div class="slider-label">
          <span>åŸç”»å¿ å®Ÿåº¦</span>
          <span class="current-value" id="fidelityValue">80%</span>
        </div>
        <input type="range" id="fidelitySlider" min="0" max="100" value="80" step="10" />
        <div class="preset-btns">
          <div class="preset-btn" onclick="setFidelity(20)">è‡ªç”±å¤‰æ›</div>
          <div class="preset-btn" onclick="setFidelity(50)">ãƒãƒ©ãƒ³ã‚¹</div>
          <div class="preset-btn" onclick="setFidelity(80)">å¿ å®Ÿ</div>
        </div>
        <div class="description-box" id="fidelityDescription">
          åŸç”»ã®æ§‹å›³ãƒ»é…è‰²ã‚’ç¶­æŒã—ã¤ã¤å¦–æ€ªåŒ–ã—ã¾ã™
        </div>
      </div>
    </div>

    <!-- ä¸­å¤®ãƒ‘ãƒãƒ«: çµæœè¡¨ç¤º -->
    <div class="center-panel panel">
      <div class="section-title">å¬å–šçµæœ</div>
      
      <div class="image-display">
        <div class="placeholder-text" id="placeholder">ğŸ‘¾ ã“ã“ã«å¦–æ€ªãŒå‡ºç¾ã—ã¾ã™ ğŸ‘¾</div>
        <canvas id="resultCanvas" style="display: none; max-width: 100%; max-height: 100%; border-radius: 8px;"></canvas>
      </div>

      <button id="summonBtn" onclick="summonMonster()">ğŸ”® å¦–æ€ªå¬å–šå®Ÿè¡Œ</button>
      <button class="save-btn" id="saveBtn" onclick="saveToCloud()" disabled>ğŸ’¾ å±•ç¤ºé¤¨ã«ä¿å­˜ï¼ˆFirebaseï¼‰</button>

      <div class="loading" id="loading">
        <div class="loading-text">âš¡ å¬å–šä¸­... âš¡</div>
        <div class="progress-wrap">
          <div class="progress-label">
            <span>ç”Ÿæˆé€²æ—</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="progress-bar-bg">
            <div class="progress-bar-fill" id="progressBar"></div>
          </div>
        </div>
      </div>

      <div class="status-message" id="error"></div>
      <div class="status-message" id="success"></div>
    </div>

    <!-- å³ãƒ‘ãƒãƒ«: æƒ…å ± -->
    <div class="right-panel panel">
      <div class="section-title">ğŸ“– ä½¿ã„æ–¹</div>
      <div class="description-box">
        <strong>1. åŸæ–™æŠ•å…¥</strong><br>
        â€¢ å¦–æ€ªåŒ–ã—ãŸã„ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰<br>
        â€¢ å¦–æ€ªã®åå‰ã‚’å…¥åŠ›ï¼ˆä»»æ„ï¼‰<br><br>
        
        <strong>2. å¿ å®Ÿåº¦èª¿æ•´</strong><br>
        â€¢ é«˜: åŸç”»ã«å¿ å®Ÿãªå¤‰æ›<br>
        â€¢ ä½: å‰µé€ çš„ãªå¤‰æ›<br><br>
        
        <strong>3. å¬å–šå®Ÿè¡Œ</strong><br>
        â€¢ ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦å¦–æ€ªã‚’ç”Ÿæˆ<br>
        â€¢ å®Œæˆã—ãŸã‚‰å±•ç¤ºé¤¨ã«ä¿å­˜å¯èƒ½<br><br>
        
        <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ</strong><br>
        â€¢ äººç‰©ã‚„å‹•ç‰©ã®å†™çœŸãŒãŠã™ã™ã‚<br>
        â€¢ è¿½åŠ æŒ‡ç¤ºã§ç´°ã‹ã„èª¿æ•´ã‚‚å¯èƒ½<br>
        â€¢ ãƒªã‚¢ãƒ«ãªå¦–æ€ªã‚¹ã‚¿ã‚¤ãƒ«ã§ç”Ÿæˆã•ã‚Œã¾ã™
      </div>

      <div class="section-title">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</div>
      <div class="description-box">
        <strong>ç”ŸæˆAI:</strong> Gemini 2.5 Flash Image<br>
        <strong>ã‚¹ã‚¿ã‚¤ãƒ«:</strong> Realistic Yokai<br>
        <strong>ç¸¦æ¨ªæ¯”:</strong> 16:10<br>
        <strong>ç”»åƒä¿å­˜:</strong> ImgBB Cloud<br>
        <strong>URLç®¡ç†:</strong> Firebase Realtime Database
      </div>

      <div class="firebase-status" id="firebaseStatus">
        ğŸ”¥ Firebase: æ¥ç¶šç¢ºèªä¸­...
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, push, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // ========================================
    // ğŸ”¥ Firebaseè¨­å®šï¼ˆã“ã“ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼‰
    // ========================================

    const firebaseConfig = {
      apiKey: "AIzaSyBwl3fDVTTHpvyYn9fP-AgKVo-bjGZfAK0",
      authDomain: "bakebake-garalley.firebaseapp.com",
      databaseURL: "https://bakebake-garalley-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "bakebake-garalley",
      storageBucket: "bakebake-garalley.firebasestorage.app",
      messagingSenderId: "215696593569",
      appId: "1:215696593569:web:35dffc96aae1cb186896e0"
    };

    // FirebaseåˆæœŸåŒ–
    let app, database;
    try {
      app = initializeApp(firebaseConfig);
      database = getDatabase(app);
      document.getElementById('firebaseStatus').textContent = 'ğŸ”¥ Firebase: æ¥ç¶šæˆåŠŸï¼';
      console.log('Firebase initialized successfully');
    } catch (error) {
      document.getElementById('firebaseStatus').textContent = 'ğŸ”¥ Firebase: æ¥ç¶šã‚¨ãƒ©ãƒ¼ï¼ˆè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰';
      console.error('Firebase initialization error:', error);
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebasePush = push;
    window.firebaseSet = set;
  </script>

  <script>
    // ====== API Keyç®¡ç† ======
    let GEMINI_API_KEY = localStorage.getItem('gemini_api_key');
    let IMGBB_API_KEY = localStorage.getItem('imgbb_api_key');

    // åˆå›èµ·å‹•æ™‚ã®è¨­å®š
    if (!GEMINI_API_KEY || !IMGBB_API_KEY) {
      const setupMessage = 'ğŸ”‘ API Keyã®åˆæœŸè¨­å®šãŒå¿…è¦ã§ã™\n\n' +
        'ä»¥ä¸‹ã®2ã¤ã®APIã‚­ãƒ¼ã‚’é †ç•ªã«å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š\n' +
        '1. Gemini API Key\n' +
        '2. ImgBB API Key\n\n' +
        'ï¼ˆæ¬¡å›ã‹ã‚‰è‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã¾ã™ï¼‰';
      
      alert(setupMessage);
      
      if (!GEMINI_API_KEY) {
        GEMINI_API_KEY = prompt('1/2: Gemini API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (GEMINI_API_KEY) {
          localStorage.setItem('gemini_api_key', GEMINI_API_KEY);
        }
      }
      
      if (!IMGBB_API_KEY) {
        IMGBB_API_KEY = prompt('2/2: ImgBB API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (IMGBB_API_KEY) {
          localStorage.setItem('imgbb_api_key', IMGBB_API_KEY);
        }
      }
      
      if (GEMINI_API_KEY && IMGBB_API_KEY) {
        alert('âœ… API Keyã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
      } else {
        alert('âš ï¸ API KeyãŒå¿…è¦ã§ã™ã€‚å³ä¸Šã®âš™ï¸ãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šã§ãã¾ã™ã€‚');
      }
    }

    // API Keyè¨­å®šç”»é¢ã‚’é–‹ã
    function openSettings() {
      const currentGemini = GEMINI_API_KEY ? 'è¨­å®šæ¸ˆã¿ (****' + GEMINI_API_KEY.slice(-4) + ')' : 'æœªè¨­å®š';
      const currentImgBB = IMGBB_API_KEY ? 'è¨­å®šæ¸ˆã¿ (****' + IMGBB_API_KEY.slice(-4) + ')' : 'æœªè¨­å®š';
      
      const message = 'ğŸ“‹ ç¾åœ¨ã®è¨­å®š\n\n' +
        `Gemini API Key: ${currentGemini}\n` +
        `ImgBB API Key: ${currentImgBB}\n\n` +
        'API Keyã‚’å†è¨­å®šã—ã¾ã™ã‹ï¼Ÿ';
      
      if (confirm(message)) {
        const newGemini = prompt('Gemini API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', GEMINI_API_KEY || '');
        if (newGemini) {
          GEMINI_API_KEY = newGemini;
          localStorage.setItem('gemini_api_key', newGemini);
        }
        
        const newImgBB = prompt('ImgBB API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', IMGBB_API_KEY || '');
        if (newImgBB) {
          IMGBB_API_KEY = newImgBB;
          localStorage.setItem('imgbb_api_key', newImgBB);
        }
        
        alert('âœ… API Keyã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
      }
    }

    // ====== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ======
    let uploadedImage = null;
    let generatedImageBase64 = null;
    let currentFidelity = 80;
    let progressValue = 0;
    let progressTimer = null;

    // å¿ å®Ÿåº¦ã®èª¬æ˜
    const fidelityDescriptions = {
      0: 'å®Œå…¨ã«æ–°ã—ã„å‰µä½œçš„ãªå¦–æ€ªã«å¤‰æ›ã—ã¾ã™',
      20: 'åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®ã¿ç¶­æŒã—ã€å¤§èƒ†ã«å¤‰æ›ã—ã¾ã™',
      40: 'ä¸»è¦ãªè¦ç´ ã‚’æ®‹ã—ã¤ã¤ã€å‰µé€ çš„ã«å¤‰æ›ã—ã¾ã™',
      60: 'æ§‹å›³ã‚’ã‚ã‚‹ç¨‹åº¦ç¶­æŒã—ã¤ã¤å¦–æ€ªåŒ–ã—ã¾ã™',
      80: 'åŸç”»ã®æ§‹å›³ãƒ»é…è‰²ã‚’ç¶­æŒã—ã¤ã¤å¦–æ€ªåŒ–ã—ã¾ã™',
      100: 'åŸç”»ã«æœ€ã‚‚å¿ å®Ÿã«ã€ã‚¹ã‚¿ã‚¤ãƒ«ã®ã¿å¤‰æ›ã—ã¾ã™'
    };

    // ====== ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ======
    const imageInput = document.getElementById('imageInput');
    const preview = document.getElementById('preview');

    imageInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          uploadedImage = e.target.result;
          preview.src = uploadedImage;
          preview.style.display = 'block';
          showSuccess('âœ… åŸæ–™ç”»åƒã‚’æŠ•å…¥ã—ã¾ã—ãŸ');
        };
        reader.readAsDataURL(file);
      }
    });

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
    const fileUpload = document.querySelector('.file-upload');
    fileUpload.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileUpload.style.background = 'rgba(0,255,136,0.2)';
    });
    fileUpload.addEventListener('dragleave', () => {
      fileUpload.style.background = 'rgba(0,255,136,0.05)';
    });
    fileUpload.addEventListener('drop', (e) => {
      e.preventDefault();
      fileUpload.style.background = 'rgba(0,255,136,0.05)';
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          uploadedImage = e.target.result;
          preview.src = uploadedImage;
          preview.style.display = 'block';
          showSuccess('âœ… åŸæ–™ç”»åƒã‚’æŠ•å…¥ã—ã¾ã—ãŸ');
        };
        reader.readAsDataURL(file);
      }
    });

    // ====== å¿ å®Ÿåº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ ======
    const fidelitySlider = document.getElementById('fidelitySlider');
    fidelitySlider.addEventListener('input', function() {
      currentFidelity = parseInt(this.value);
      updateFidelityDisplay();
    });

    function setFidelity(value) {
      currentFidelity = value;
      fidelitySlider.value = value;
      updateFidelityDisplay();
    }

    function updateFidelityDisplay() {
      document.getElementById('fidelityValue').textContent = currentFidelity + '%';
      const closestKey = Object.keys(fidelityDescriptions)
        .map(Number)
        .reduce((prev, curr) => Math.abs(curr - currentFidelity) < Math.abs(prev - currentFidelity) ? curr : prev);
      document.getElementById('fidelityDescription').textContent = fidelityDescriptions[closestKey];
    }
    updateFidelityDisplay();

    // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = 'âŒ ' + message;
      errorDiv.style.display = 'block';
      document.getElementById('success').style.display = 'none';
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('success');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      document.getElementById('error').style.display = 'none';
    }

    function buildPrompt() {
      const monsterName = document.getElementById('monsterName').value.trim();
      let prompt = "";

      if (monsterName) {
        prompt = `Transform this into a ${monsterName} (Japanese yokai monster) in a photorealistic style. `;
      } else {
        prompt = `Transform this into a Japanese yokai monster in a photorealistic style. `;
      }

      if (currentFidelity >= 100) {
        prompt += "IMPORTANT: Preserve exact composition, layout, colors. Only change rendering style to realistic yokai.";
      } else if (currentFidelity >= 80) {
        prompt += "IMPORTANT: Preserve exact composition, layout, colors. Only change rendering style to realistic yokai.";
      } else if (currentFidelity >= 60) {
        prompt += "Keep main composition similar. Maintain colors and positioning while transforming into realistic yokai.";
      } else if (currentFidelity >= 40) {
        prompt += "Keep general composition but adjust details and lighting for realistic yokai appearance.";
      } else if (currentFidelity >= 20) {
        prompt += "Keep main subject but reimagine creatively as a realistic yokai monster.";
      } else {
        prompt += "Keep only basic concept and create something new as a realistic yokai monster.";
      }

      const custom = document.getElementById('customPrompt').value.trim();
      if (custom) prompt += ` Additional instructions: ${custom}`;

      return prompt;
    }

    // ====== é€²æ—ãƒãƒ¼åˆ¶å¾¡ ======
    function startProgress() {
      progressValue = 0;
      const bar = document.getElementById('progressBar');
      const label = document.getElementById('progressPercent');
      bar.style.width = '0%';
      label.textContent = '0%';

      if (progressTimer) clearInterval(progressTimer);
      progressTimer = setInterval(() => {
        const increment = Math.max(0.2, (90 - progressValue) * 0.03);
        progressValue = Math.min(90, progressValue + increment);
        bar.style.width = progressValue.toFixed(0) + '%';
        label.textContent = progressValue.toFixed(0) + '%';
      }, 120);
    }

    function finishProgress() {
      const bar = document.getElementById('progressBar');
      const label = document.getElementById('progressPercent');
      if (progressTimer) { clearInterval(progressTimer); progressTimer = null; }
      progressValue = 100;
      bar.style.width = '100%';
      label.textContent = '100%';
    }

    function resetProgress() {
      const bar = document.getElementById('progressBar');
      const label = document.getElementById('progressPercent');
      if (progressTimer) { clearInterval(progressTimer); progressTimer = null; }
      progressValue = 0;
      bar.style.width = '0%';
      label.textContent = '0%';
    }

    // ====== å¬å–šå‡¦ç† ======
    async function summonMonster() {
      // API Keyãƒã‚§ãƒƒã‚¯
      if (!GEMINI_API_KEY) {
        showError('Gemini API KeyãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚âš™ï¸ãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      if (!uploadedImage) return showError('åŸæ–™ç”»åƒã‚’æŠ•å…¥ã—ã¦ãã ã•ã„');

      document.getElementById('summonBtn').disabled = true;
      document.getElementById('saveBtn').disabled = true;
      document.getElementById('loading').style.display = 'block';
      document.getElementById('error').style.display = 'none';
      document.getElementById('success').style.display = 'none';
      document.getElementById('placeholder').style.display = 'none';
      document.getElementById('resultCanvas').style.display = 'none';
      startProgress();

      try {
        const prompt = buildPrompt();
        const base64Data = uploadedImage.split(',')[1];
        const mimeType = uploadedImage.split(',')[0].split(':')[1].split(';')[0];

        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              contents: [{
                parts: [
                  { inline_data: { mime_type: mimeType, data: base64Data } },
                  { text: prompt }
                ]
              }]
            })
          }
        );

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error?.message || 'å¬å–šã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const data = await response.json();

        let transformedImageData = null;
        let resultMime = 'image/png';
        if (data && data.candidates && data.candidates.length) {
          for (const cand of data.candidates) {
            if (!cand.content || !cand.content.parts) continue;
            for (const part of cand.content.parts) {
              if (part.inlineData) {
                transformedImageData = part.inlineData.data;
                resultMime = part.inlineData.mimeType || 'image/png';
                break;
              }
            }
            if (transformedImageData) break;
          }
        }
        if (!transformedImageData) {
          throw new Error('ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        }

        generatedImageBase64 = transformedImageData;
        const url = `data:${resultMime};base64,${generatedImageBase64}`;

        // Canvasä¸Šã«ç”»åƒã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆæˆ
        await drawImageWithText(url);
        
        document.getElementById('saveBtn').disabled = false;
        showSuccess('âœ… å¦–æ€ªå¬å–šæˆåŠŸï¼');

        finishProgress();
      } catch (err) {
        showError('ã‚¨ãƒ©ãƒ¼: ' + err.message);
        resetProgress();
        document.getElementById('placeholder').style.display = 'block';
      } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('summonBtn').disabled = false;
      }
    }

    // ====== Canvasç”»åƒåˆæˆå‡¦ç† ======
    async function drawImageWithText(imageUrl) {
      return new Promise((resolve, reject) => {
        const canvas = document.getElementById('resultCanvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
          // Canvasã‚µã‚¤ã‚ºã‚’ç”»åƒã«åˆã‚ã›ã‚‹
          canvas.width = img.width;
          canvas.height = img.height;
          
          // ç”»åƒã‚’æç”»
          ctx.drawImage(img, 0, 0);
          
          // ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—
          const monsterName = document.getElementById('monsterName').value.trim() || 'åç„¡ã—ã®å¦–æ€ª';
          const customPrompt = document.getElementById('customPrompt').value.trim();
          
          // ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã®è¨­å®šï¼ˆ1.5å€ã«æ‹¡å¤§ï¼‰
          const boxHeight = customPrompt ? 150 : 105;
          const boxY = canvas.height - boxHeight;
          
          // åŠé€æ˜ã®é»’èƒŒæ™¯ã‚’æç”»
          ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
          ctx.fillRect(0, boxY, canvas.width, boxHeight);
          
          // ãƒ†ã‚­ã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
          ctx.fillStyle = '#00ff88';
          ctx.textAlign = 'left';
          ctx.textBaseline = 'top';
          
          // å¦–æ€ªåã‚’æç”»ï¼ˆğŸ‘¹ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤ï¼‰
          const fontSize = Math.min(canvas.width / 15, 40);
          ctx.font = `bold ${fontSize}px "Courier New", monospace`;
          ctx.fillText(monsterName, 20, boxY + 15);
          
          // ç‰¹å¾´ã‚’æç”»ï¼ˆè¿½åŠ æŒ‡ç¤ºãŒã‚ã‚‹å ´åˆï¼‰
          if (customPrompt) {
            const descFontSize = Math.min(canvas.width / 25, 24);
            ctx.font = `${descFontSize}px "Courier New", monospace`;
            ctx.fillStyle = '#88ffaa';
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ˜ã‚Šè¿”ã—
            const maxWidth = canvas.width - 40;
            const words = customPrompt.split('');
            let line = '';
            let y = boxY + 15 + fontSize + 10;
            
            for (let i = 0; i < words.length; i++) {
              const testLine = line + words[i];
              const metrics = ctx.measureText(testLine);
              if (metrics.width > maxWidth && i > 0) {
                ctx.fillText(line, 20, y);
                line = words[i];
                y += descFontSize + 5;
              } else {
                line = testLine;
              }
            }
            ctx.fillText(line, 20, y);
          }
          
          // Canvasã‚’è¡¨ç¤º
          canvas.style.display = 'block';
          
          // Canvasç”»åƒã‚’Base64ã«å¤‰æ›ã—ã¦ä¿å­˜ç”¨å¤‰æ•°ã«æ ¼ç´
          generatedImageBase64 = canvas.toDataURL('image/png').split(',')[1];
          
          resolve();
        };
        
        img.onerror = function() {
          reject(new Error('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        };
        
        img.src = imageUrl;
      });
    }

    // ====== ä¿å­˜å‡¦ç†ï¼ˆImgBB + Firebaseï¼‰ ======
    async function saveToCloud() {
      // API Keyãƒã‚§ãƒƒã‚¯
      if (!IMGBB_API_KEY) {
        showError('ImgBB API KeyãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚âš™ï¸ãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      if (!generatedImageBase64) return showError('ä¿å­˜ã™ã‚‹ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«å¬å–šã—ã¦ãã ã•ã„ã€‚');
      if (!window.firebaseDB) return showError('Firebaseã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');

      document.getElementById('saveBtn').disabled = true;
      document.getElementById('error').style.display = 'none';
      document.getElementById('success').style.display = 'none';

      try {
        // 1. ImgBBã«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const formData = new FormData();
        formData.append('image', generatedImageBase64);
        const monsterName = document.getElementById('monsterName').value || 'yokai';
        formData.append('name', monsterName);

        const imgbbResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
          method: 'POST',
          body: formData
        });

        if (!imgbbResponse.ok) {
          const errorData = await imgbbResponse.json().catch(() => ({}));
          throw new Error(errorData.error?.message || 'ImgBBã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const imgbbData = await imgbbResponse.json();
        if (!imgbbData.success || !imgbbData.data) {
          throw new Error('ImgBBã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const imageUrl = imgbbData.data.display_url || imgbbData.data.url;

        // 2. Firebaseã«URLã‚’ä¿å­˜
        const monstersRef = window.firebaseRef(window.firebaseDB, 'monsters');
        const newMonsterRef = window.firebasePush(monstersRef);
        await window.firebaseSet(newMonsterRef, {
          url: imageUrl,
          name: monsterName,
          timestamp: new Date().toISOString(),
          fidelity: currentFidelity
        });

        showSuccess(`âœ… å±•ç¤ºé¤¨ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼`);
      } catch (err) {
        showError('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + err.message);
      } finally {
        document.getElementById('saveBtn').disabled = false;
      }
    }

    console.log('âœ¨ ã°ã‘ã°ã‘å¬å–šè£…ç½®ï¼ˆFirebaseç‰ˆï¼‰èµ·å‹•å®Œäº† âœ¨');
  </script>
</body>
</html>
